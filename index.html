<!DOCTYPE html>
<html lang="zh-CN">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>ğŸ¾ ç½‘çƒå°ç»„èµ›è®¡åˆ†ç³»ç»Ÿ</title>
  <link rel="icon" href="data:image/svg+xml,<svg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 100 100'><text y='.9em' font-size='90'>ğŸ¾</text></svg>">
  <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
  <link href="https://fonts.googleapis.com/css2?family=Outfit:wght@300;400;500;600;700&display=swap" rel="stylesheet">
  <style>
    :root {
      --bg-dark: #0a1628;
      --bg-card: #132337;
      --accent: #4ade80;
      --accent-dim: #22c55e;
      --text: #e2e8f0;
      --text-dim: #94a3b8;
      --court-green: #2d5a27;
      --court-line: #ffffff;
      --danger: #ef4444;
      --warning: #f59e0b;
    }
    
    * {
      margin: 0;
      padding: 0;
      box-sizing: border-box;
    }
    
    body {
      font-family: 'Outfit', sans-serif;
      background: var(--bg-dark);
      color: var(--text);
      min-height: 100vh;
      background-image: 
        radial-gradient(ellipse at top, #1a3a2f 0%, transparent 50%),
        radial-gradient(ellipse at bottom right, #1e3a5f 0%, transparent 50%);
    }
    
    .container {
      max-width: 1200px;
      margin: 0 auto;
      padding: 20px;
    }
    
    header {
      text-align: center;
      padding: 40px 20px;
      border-bottom: 1px solid rgba(74, 222, 128, 0.2);
      margin-bottom: 40px;
    }
    
    header h1 {
      font-size: 2.5rem;
      font-weight: 700;
      background: linear-gradient(135deg, #4ade80, #22d3ee);
      -webkit-background-clip: text;
      -webkit-text-fill-color: transparent;
      background-clip: text;
      margin-bottom: 10px;
    }
    
    header p {
      color: var(--text-dim);
      font-size: 1.1rem;
    }
    
    .setup-notice {
      background: linear-gradient(135deg, #f59e0b20, #ef444420);
      border: 1px solid var(--warning);
      border-radius: 12px;
      padding: 20px;
      margin-bottom: 30px;
      text-align: center;
    }
    
    .setup-notice h3 {
      color: var(--warning);
      margin-bottom: 10px;
    }
    
    .setup-notice code {
      background: #00000040;
      padding: 2px 8px;
      border-radius: 4px;
      font-size: 0.9rem;
    }
    
    .tabs {
      display: flex;
      gap: 10px;
      margin-bottom: 30px;
      flex-wrap: wrap;
    }
    
    .tab {
      padding: 12px 24px;
      background: var(--bg-card);
      border: 1px solid rgba(255,255,255,0.1);
      border-radius: 30px;
      cursor: pointer;
      transition: all 0.3s;
      font-family: inherit;
      color: var(--text-dim);
      font-size: 1rem;
    }
    
    .tab:hover {
      border-color: var(--accent);
      color: var(--text);
    }
    
    .tab.active {
      background: var(--accent);
      color: var(--bg-dark);
      font-weight: 600;
      border-color: var(--accent);
    }
    
    .panel {
      display: none;
    }
    
    .panel.active {
      display: block;
    }
    
    .card {
      background: var(--bg-card);
      border-radius: 16px;
      padding: 24px;
      margin-bottom: 20px;
      border: 1px solid rgba(255,255,255,0.05);
    }
    
    .card h2 {
      font-size: 1.3rem;
      margin-bottom: 20px;
      display: flex;
      align-items: center;
      gap: 10px;
    }
    
    .form-row {
      display: flex;
      gap: 12px;
      margin-bottom: 15px;
      flex-wrap: wrap;
    }
    
    input, select {
      padding: 12px 16px;
      border-radius: 10px;
      border: 1px solid rgba(255,255,255,0.1);
      background: rgba(0,0,0,0.3);
      color: var(--text);
      font-family: inherit;
      font-size: 1rem;
      flex: 1;
      min-width: 120px;
    }
    
    input:focus, select:focus {
      outline: none;
      border-color: var(--accent);
    }
    
    select option {
      background: var(--bg-dark);
    }
    
    button {
      padding: 12px 24px;
      border-radius: 10px;
      border: none;
      background: var(--accent);
      color: var(--bg-dark);
      font-family: inherit;
      font-size: 1rem;
      font-weight: 600;
      cursor: pointer;
      transition: all 0.3s;
    }
    
    button:hover {
      background: var(--accent-dim);
      transform: translateY(-2px);
    }
    
    button.secondary {
      background: transparent;
      border: 1px solid var(--accent);
      color: var(--accent);
    }
    
    button.danger {
      background: var(--danger);
      color: white;
    }
    
    button.small {
      padding: 6px 12px;
      font-size: 0.85rem;
    }
    
    /* Rankings Table */
    .rankings-table {
      width: 100%;
      border-collapse: collapse;
    }
    
    .rankings-table th,
    .rankings-table td {
      padding: 16px;
      text-align: left;
      border-bottom: 1px solid rgba(255,255,255,0.05);
    }
    
    .rankings-table th {
      color: var(--text-dim);
      font-weight: 500;
      font-size: 0.9rem;
      text-transform: uppercase;
      letter-spacing: 1px;
    }
    
    .rankings-table tr:hover {
      background: rgba(74, 222, 128, 0.05);
    }
    
    .rank {
      font-size: 1.5rem;
      font-weight: 700;
    }
    
    .rank-1 { color: #ffd700; }
    .rank-2 { color: #c0c0c0; }
    .rank-3 { color: #cd7f32; }
    
    .player-name {
      font-weight: 600;
      font-size: 1.1rem;
    }
    
    .stat {
      color: var(--text-dim);
    }
    
    .stat.positive {
      color: var(--accent);
    }
    
    .stat.negative {
      color: var(--danger);
    }
    
    /* Players List */
    .players-grid {
      display: grid;
      grid-template-columns: repeat(auto-fill, minmax(200px, 1fr));
      gap: 15px;
    }
    
    .player-card {
      background: rgba(0,0,0,0.2);
      border-radius: 12px;
      padding: 16px;
      display: flex;
      justify-content: space-between;
      align-items: center;
      border: 1px solid rgba(255,255,255,0.05);
    }
    
    .player-card span {
      font-weight: 500;
      flex: 1;
    }
    
    /* Matches List */
    .match-card {
      background: rgba(0,0,0,0.2);
      border-radius: 12px;
      padding: 20px;
      margin-bottom: 15px;
      border: 1px solid rgba(255,255,255,0.05);
    }
    
    .match-header {
      display: flex;
      justify-content: space-between;
      align-items: center;
      margin-bottom: 15px;
    }
    
    .match-players {
      font-size: 1.2rem;
      font-weight: 600;
    }
    
    .match-players .winner {
      color: var(--accent);
    }
    
    .match-date {
      color: var(--text-dim);
      font-size: 0.9rem;
    }
    
    .match-sets {
      display: flex;
      gap: 15px;
      flex-wrap: wrap;
    }
    
    .set-score {
      background: var(--bg-card);
      padding: 8px 16px;
      border-radius: 8px;
      font-weight: 500;
    }
    
    .set-score.won {
      background: rgba(74, 222, 128, 0.2);
      color: var(--accent);
    }
    
    /* Match Form */
    .set-inputs {
      display: flex;
      gap: 20px;
      flex-wrap: wrap;
      margin: 15px 0;
    }
    
    .set-input-group {
      display: flex;
      align-items: center;
      gap: 8px;
    }
    
    .set-input-group label {
      color: var(--text-dim);
      font-size: 0.9rem;
    }
    
    .set-input-group input {
      width: 60px;
      text-align: center;
    }
    
    .vs {
      color: var(--text-dim);
    }
    
    /* Empty State */
    .empty-state {
      text-align: center;
      padding: 60px 20px;
      color: var(--text-dim);
    }
    
    .empty-state span {
      font-size: 3rem;
      display: block;
      margin-bottom: 15px;
    }
    
    /* Responsive */
    @media (max-width: 768px) {
      .container {
        padding: 10px;
      }
      
      header {
        padding: 20px 10px;
        margin-bottom: 20px;
      }
      
      header h1 {
        font-size: 1.5rem;
      }
      
      header p {
        font-size: 0.9rem;
      }
      
      .tabs {
        display: flex;
        overflow-x: auto;
        gap: 8px;
        padding-bottom: 10px;
        -webkit-overflow-scrolling: touch;
      }
      
      .tab {
        padding: 10px 16px;
        font-size: 0.9rem;
        white-space: nowrap;
        flex-shrink: 0;
      }
      
      .card {
        padding: 16px;
        border-radius: 12px;
      }
      
      .card h2 {
        font-size: 1.1rem;
      }
      
      /* æ’åè¡¨æ ¼ - æ¨ªå‘æ»šåŠ¨ */
      .rankings-table {
        display: block;
        overflow-x: auto;
        -webkit-overflow-scrolling: touch;
      }
      
      .rankings-table th,
      .rankings-table td {
        padding: 10px 8px;
        font-size: 0.8rem;
        white-space: nowrap;
      }
      
      .rank {
        font-size: 1.1rem;
      }
      
      .player-name {
        font-size: 1rem;
      }
      
      /* è¡¨å• */
      .form-row {
        flex-direction: column;
        gap: 10px;
      }
      
      .form-row .vs {
        text-align: center;
      }
      
      input, select {
        padding: 14px 16px;
        font-size: 16px; /* é˜²æ­¢ iOS ç¼©æ”¾ */
      }
      
      button {
        padding: 14px 20px;
        width: 100%;
      }
      
      /* æ¯”åˆ†è¾“å…¥ */
      .set-inputs {
        flex-direction: column;
        gap: 15px;
      }
      
      .set-input-group {
        width: 100%;
        justify-content: space-between;
        background: rgba(0,0,0,0.2);
        padding: 12px;
        border-radius: 10px;
      }
      
      .set-input-group input {
        width: 50px;
        padding: 10px;
      }
      
      /* æ¯”èµ›å¡ç‰‡ */
      .match-card {
        padding: 15px;
      }
      
      .match-header {
        flex-direction: column;
        align-items: flex-start;
        gap: 10px;
      }
      
      .match-players {
        font-size: 1rem;
      }
      
      .match-sets {
        gap: 8px;
      }
      
      .set-score {
        padding: 6px 12px;
        font-size: 0.85rem;
      }
      
      /* é€‰æ‰‹ç½‘æ ¼ */
      .players-grid {
        grid-template-columns: 1fr;
        gap: 10px;
      }
      
      .player-card {
        padding: 14px;
      }
      
      .player-card button {
        width: auto;
        padding: 8px 16px;
        flex-shrink: 0;
      }
      
      /* ç©ºçŠ¶æ€ */
      .empty-state {
        padding: 40px 15px;
      }
      
      .empty-state span {
        font-size: 2.5rem;
      }
    }
    
    /* æ›´å°çš„å±å¹• */
    @media (max-width: 480px) {
      header h1 {
        font-size: 1.3rem;
      }
      
      .tab {
        padding: 8px 12px;
        font-size: 0.85rem;
      }
      
      .rankings-table th,
      .rankings-table td {
        padding: 8px 6px;
        font-size: 0.75rem;
      }
    }

    .loading {
      text-align: center;
      padding: 40px;
      color: var(--text-dim);
    }

    .error {
      background: rgba(239, 68, 68, 0.1);
      border: 1px solid var(--danger);
      border-radius: 12px;
      padding: 20px;
      color: var(--danger);
      margin-bottom: 20px;
    }

    .badge {
      display: inline-block;
      padding: 4px 10px;
      border-radius: 20px;
      font-size: 0.8rem;
      font-weight: 600;
    }

    .badge.qualified {
      background: rgba(74, 222, 128, 0.2);
      color: var(--accent);
    }

    /* News Panel Styles */
    .news-section {
      margin-bottom: 24px;
    }

    .news-section h3 {
      color: var(--accent);
      font-size: 1.1rem;
      margin-bottom: 12px;
      padding-bottom: 8px;
      border-bottom: 1px solid rgba(74, 222, 128, 0.2);
    }

    .news-match {
      background: rgba(0, 0, 0, 0.2);
      border-radius: 10px;
      padding: 12px 16px;
      margin-bottom: 10px;
      border-left: 3px solid var(--bg-card);
    }

    .news-match.live {
      border-left-color: #ef4444;
      animation: pulse-border 2s infinite;
    }

    .news-match.completed {
      border-left-color: var(--accent);
    }

    .news-match .players {
      font-weight: 600;
      margin-bottom: 4px;
    }

    .news-match .score {
      color: var(--text-dim);
      font-size: 0.9rem;
    }

    .news-match .live-badge {
      display: inline-block;
      background: #ef4444;
      color: white;
      padding: 2px 8px;
      border-radius: 4px;
      font-size: 0.75rem;
      font-weight: 600;
      margin-left: 8px;
      animation: pulse 1.5s infinite;
    }

    @keyframes pulse {
      0%, 100% { opacity: 1; }
      50% { opacity: 0.6; }
    }

    @keyframes pulse-border {
      0%, 100% { border-left-color: #ef4444; }
      50% { border-left-color: #f87171; }
    }

    .news-empty {
      text-align: center;
      padding: 40px 20px;
      color: var(--text-dim);
    }

    .news-raw {
      font-size: 0.95rem;
      line-height: 1.6;
    }

    .news-tournament {
      color: var(--accent);
      font-size: 1.1rem;
      margin: 20px 0 12px 0;
      padding-bottom: 8px;
      border-bottom: 1px solid rgba(74, 222, 128, 0.2);
    }

    .news-tournament:first-child {
      margin-top: 0;
    }

    .news-tie {
      color: var(--text);
      font-size: 1rem;
      margin: 16px 0 8px 0;
      padding: 8px 12px;
      background: rgba(74, 222, 128, 0.1);
      border-radius: 8px;
      font-weight: 600;
    }
  </style>
</head>
<body>
  <div class="container">
    <header>
      <h1>ğŸ¾ ç½‘çƒå°ç»„èµ›è®¡åˆ†ç³»ç»Ÿ</h1>
      <p>Round Robin Tournament Tracker</p>
    </header>

    <div id="setup-notice" class="setup-notice" style="display: none;">
      <h3>âš ï¸ éœ€è¦é…ç½® Supabase</h3>
      <p>è¯·åœ¨é¡µé¢åº•éƒ¨çš„ JavaScript ä¸­å¡«å…¥ä½ çš„ Supabase URL å’Œ Key</p>
      <p style="margin-top: 10px;">
        <code>SUPABASE_URL</code> å’Œ <code>SUPABASE_ANON_KEY</code>
      </p>
    </div>

    <div class="tabs">
      <button class="tab active" data-tab="rankings">ğŸ“Š æ’å</button>
      <button class="tab" data-tab="matches">ğŸ† æ¯”èµ›è®°å½•</button>
      <button class="tab" data-tab="add-match">â• æ·»åŠ æ¯”èµ›</button>
      <button class="tab" data-tab="players">ğŸ‘¥ é€‰æ‰‹ç®¡ç†</button>
      <button class="tab" data-tab="news">ğŸ“° News</button>
    </div>

    <!-- Rankings Panel -->
    <div id="rankings" class="panel active">
      <div class="card">
        <h2>ğŸ“Š å½“å‰æ’å</h2>
        <div id="rankings-content">
          <div class="loading">åŠ è½½ä¸­...</div>
        </div>
      </div>
    </div>

    <!-- Matches Panel -->
    <div id="matches" class="panel">
      <div class="card">
        <h2>ğŸ† æ¯”èµ›è®°å½•</h2>
        <div id="matches-content">
          <div class="loading">åŠ è½½ä¸­...</div>
        </div>
      </div>
    </div>

    <!-- Add Match Panel -->
    <div id="add-match" class="panel">
      <div class="card">
        <h2>â• æ·»åŠ æ¯”èµ›ç»“æœ</h2>
        <form id="match-form">
          <div class="form-row">
            <select id="player1" required>
              <option value="">é€‰æ‹©é€‰æ‰‹ 1</option>
            </select>
            <span class="vs" style="align-self: center;">VS</span>
            <select id="player2" required>
              <option value="">é€‰æ‹©é€‰æ‰‹ 2</option>
            </select>
          </div>
          
          <p style="color: var(--text-dim); margin-bottom: 15px;">æ¯ç›˜æ¯”åˆ†ï¼ˆä¸‰ç›˜ä¸¤èƒœï¼Œç¬¬ä¸‰ç›˜ä¸º 10 åˆ†æŠ¢åï¼‰</p>
          
          <div class="set-inputs">
            <div class="set-input-group">
              <label>ç¬¬ä¸€ç›˜</label>
              <input type="number" id="set1-p1" min="0" max="7" placeholder="0" required>
              <span class="vs">:</span>
              <input type="number" id="set1-p2" min="0" max="7" placeholder="0" required>
            </div>
            <div class="set-input-group">
              <label>ç¬¬äºŒç›˜</label>
              <input type="number" id="set2-p1" min="0" max="7" placeholder="0" required>
              <span class="vs">:</span>
              <input type="number" id="set2-p2" min="0" max="7" placeholder="0" required>
            </div>
            <div class="set-input-group">
              <label>ç¬¬ä¸‰ç›˜ (æŠ¢å)</label>
              <input type="number" id="set3-p1" min="0" max="15" placeholder="-">
              <span class="vs">:</span>
              <input type="number" id="set3-p2" min="0" max="15" placeholder="-">
            </div>
          </div>
          
          <button type="submit">ä¿å­˜æ¯”èµ›ç»“æœ</button>
        </form>
      </div>
    </div>

    <!-- Players Panel -->
    <div id="players" class="panel">
      <div class="card">
        <h2>ğŸ‘¥ é€‰æ‰‹ç®¡ç†</h2>
        <form id="player-form" class="form-row">
          <input type="text" id="player-name" placeholder="è¾“å…¥é€‰æ‰‹åå­—" required>
          <button type="submit">æ·»åŠ é€‰æ‰‹</button>
        </form>
        <div id="players-list" class="players-grid" style="margin-top: 20px;">
          <div class="loading">åŠ è½½ä¸­...</div>
        </div>
      </div>
    </div>

    <!-- News Panel -->
    <div id="news" class="panel">
      <div class="card">
        <h2>ğŸ“° ATP/WTA Live Scores</h2>
        <div class="news-header" style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 20px;">
          <p style="color: var(--text-dim);">Latest tennis scores from around the world</p>
          <span id="news-updated" style="color: var(--text-dim); font-size: 0.85rem;"></span>
        </div>
        <div id="news-content">
          <div class="loading">Loading scores...</div>
        </div>
      </div>
    </div>
  </div>

  <!-- é…ç½®æ–‡ä»¶ï¼ˆä¸ä¸Šä¼ åˆ° GitHubï¼‰ -->
  <script src="config.js"></script>
  <script>
    let db;
    let players = [];
    let matches = [];

    // åˆå§‹åŒ–
    async function init() {
      if (typeof CONFIG === 'undefined' || !CONFIG.SUPABASE_URL || CONFIG.SUPABASE_URL === 'YOUR_SUPABASE_URL') {
        document.getElementById('setup-notice').style.display = 'block';
        return;
      }

      db = window.supabase.createClient(CONFIG.SUPABASE_URL, CONFIG.SUPABASE_ANON_KEY);
      
      await loadData();
      setupEventListeners();
    }

    // åŠ è½½æ•°æ®
    async function loadData() {
      try {
        const [playersRes, matchesRes] = await Promise.all([
          db.from('players').select('*').order('name'),
          db.from('matches').select('*').order('created_at', { ascending: false })
        ]);

        if (playersRes.error) throw playersRes.error;
        if (matchesRes.error) throw matchesRes.error;

        players = playersRes.data || [];
        matches = matchesRes.data || [];

        renderAll();
      } catch (error) {
        console.error('åŠ è½½æ•°æ®å¤±è´¥:', error);
        showError('åŠ è½½æ•°æ®å¤±è´¥: ' + error.message);
      }
    }

    // æ¸²æŸ“æ‰€æœ‰å†…å®¹
    function renderAll() {
      renderRankings();
      renderMatches();
      renderPlayers();
      updatePlayerSelects();
    }

    // è®¡ç®—æ’å
    function calculateRankings() {
      const stats = {};

      // åˆå§‹åŒ–ç»Ÿè®¡
      players.forEach(p => {
        stats[p.id] = {
          id: p.id,
          name: p.name,
          points: 0,
          wins: 0,
          losses: 0,
          setsWon: 0,
          setsLost: 0,
          gamesWon: 0,
          gamesLost: 0,
          headToHead: {}
        };
      });

      // ç»Ÿè®¡æ¯”èµ›æ•°æ®
      matches.forEach(match => {
        const p1 = stats[match.player1_id];
        const p2 = stats[match.player2_id];
        if (!p1 || !p2) return;

        const sets = match.sets;
        let p1Sets = 0, p2Sets = 0;
        let p1Games = 0, p2Games = 0;

        sets.forEach((set, idx) => {
          if (set[0] === null || set[1] === null) return;
          
          // åˆ¤æ–­è¿™ç›˜è°èµ¢
          if (idx === 2) {
            // ç¬¬ä¸‰ç›˜æŠ¢å - åªè®¡ç®—1å±€ç»™èƒœè€…
            if (set[0] >= 10 && set[0] > set[1]) {
              p1Sets++;
              p1Games += 1;  // æŠ¢åèƒœè€…å¾—1å±€
            } else if (set[1] >= 10 && set[1] > set[0]) {
              p2Sets++;
              p2Games += 1;  // æŠ¢åèƒœè€…å¾—1å±€
            }
          } else {
            // æ™®é€šç›˜ - æ­£å¸¸è®¡ç®—å±€æ•°
            p1Games += set[0];
            p2Games += set[1];
            
            if (set[0] > set[1]) p1Sets++;
            else if (set[1] > set[0]) p2Sets++;
          }
        });

        // æ›´æ–°ç»Ÿè®¡
        p1.setsWon += p1Sets;
        p1.setsLost += p2Sets;
        p2.setsWon += p2Sets;
        p2.setsLost += p1Sets;
        p1.gamesWon += p1Games;
        p1.gamesLost += p2Games;
        p2.gamesWon += p2Games;
        p2.gamesLost += p1Games;

        // è®°åˆ†è§„åˆ™
        if (p1Sets > p2Sets) {
          p1.points += 2;
          p1.wins++;
          p2.points += p2Sets; // è´Ÿè€…å¾—åˆ†ç­‰äºèµ¢çš„ç›˜æ•°
          p2.losses++;
          p1.headToHead[match.player2_id] = 'win';
          p2.headToHead[match.player1_id] = 'loss';
        } else {
          p2.points += 2;
          p2.wins++;
          p1.points += p1Sets;
          p1.losses++;
          p2.headToHead[match.player1_id] = 'win';
          p1.headToHead[match.player2_id] = 'loss';
        }
      });

      // æ’åº
      const rankings = Object.values(stats).sort((a, b) => {
        // 1. å…ˆæŒ‰ç§¯åˆ†æ’åº
        if (b.points !== a.points) return b.points - a.points;
        
        // 2. ä¸¤äººç§¯åˆ†ç›¸åŒï¼Œçœ‹å¯¹æˆ˜è®°å½•
        if (a.headToHead[b.id] === 'win') return -1;
        if (a.headToHead[b.id] === 'loss') return 1;
        
        // 3. ä¸‰äººåŠä»¥ä¸Šç›¸åŒï¼Œçœ‹ç›˜åˆ†å·®
        const aSetDiff = a.setsWon - a.setsLost;
        const bSetDiff = b.setsWon - b.setsLost;
        if (bSetDiff !== aSetDiff) return bSetDiff - aSetDiff;
        
        // 4. å†çœ‹å±€åˆ†å·®
        const aGameDiff = a.gamesWon - a.gamesLost;
        const bGameDiff = b.gamesWon - b.gamesLost;
        return bGameDiff - aGameDiff;
      });

      return rankings;
    }

    // æ¸²æŸ“æ’å
    function renderRankings() {
      const container = document.getElementById('rankings-content');
      const rankings = calculateRankings();

      if (rankings.length === 0) {
        container.innerHTML = `
          <div class="empty-state">
            <span>ğŸ¾</span>
            <p>è¿˜æ²¡æœ‰é€‰æ‰‹ï¼Œè¯·å…ˆæ·»åŠ é€‰æ‰‹</p>
          </div>
        `;
        return;
      }

      let html = `
        <table class="rankings-table">
          <thead>
            <tr>
              <th>æ’å</th>
              <th>é€‰æ‰‹</th>
              <th>ç§¯åˆ†</th>
              <th>èƒœ/è´Ÿ</th>
              <th>ç›˜åˆ†</th>
              <th>å±€åˆ†</th>
            </tr>
          </thead>
          <tbody>
      `;

      rankings.forEach((player, index) => {
        const rank = index + 1;
        const setDiff = player.setsWon - player.setsLost;
        const gameDiff = player.gamesWon - player.gamesLost;

        html += `
          <tr>
            <td><span class="rank rank-${rank}">${rank}</span></td>
            <td>
              <span class="player-name">${player.name}</span>
            </td>
            <td><strong>${player.points}</strong></td>
            <td>${player.wins}èƒœ ${player.losses}è´Ÿ</td>
            <td>
              <span class="stat ${setDiff > 0 ? 'positive' : setDiff < 0 ? 'negative' : ''}">
                ${player.setsWon}-${player.setsLost} (${setDiff >= 0 ? '+' : ''}${setDiff})
              </span>
            </td>
            <td>
              <span class="stat ${gameDiff > 0 ? 'positive' : gameDiff < 0 ? 'negative' : ''}">
                ${player.gamesWon}-${player.gamesLost} (${gameDiff >= 0 ? '+' : ''}${gameDiff})
              </span>
            </td>
          </tr>
        `;
      });

      html += '</tbody></table>';
      container.innerHTML = html;
    }

    // æ¸²æŸ“æ¯”èµ›åˆ—è¡¨
    function renderMatches() {
      const container = document.getElementById('matches-content');

      if (matches.length === 0) {
        container.innerHTML = `
          <div class="empty-state">
            <span>ğŸ†</span>
            <p>è¿˜æ²¡æœ‰æ¯”èµ›è®°å½•</p>
          </div>
        `;
        return;
      }

      let html = '';
      matches.forEach(match => {
        const p1 = players.find(p => p.id === match.player1_id);
        const p2 = players.find(p => p.id === match.player2_id);
        if (!p1 || !p2) return;

        // è®¡ç®—è°èµ¢
        let p1Sets = 0, p2Sets = 0;
        match.sets.forEach((set, idx) => {
          if (set[0] === null || set[1] === null) return;
          if (idx === 2) {
            if (set[0] >= 10 && set[0] > set[1]) p1Sets++;
            else if (set[1] >= 10 && set[1] > set[0]) p2Sets++;
          } else {
            if (set[0] > set[1]) p1Sets++;
            else if (set[1] > set[0]) p2Sets++;
          }
        });

        const p1Won = p1Sets > p2Sets;
        const date = new Date(match.created_at).toLocaleDateString('zh-CN');

        html += `
          <div class="match-card">
            <div class="match-header">
              <div class="match-players">
                <span class="${p1Won ? 'winner' : ''}">${p1.name}</span>
                <span style="color: var(--text-dim);"> vs </span>
                <span class="${!p1Won ? 'winner' : ''}">${p2.name}</span>
              </div>
              <div>
                <span class="match-date">${date}</span>
                <button class="small danger" onclick="deleteMatch(${match.id})" style="margin-left: 10px;">åˆ é™¤</button>
              </div>
            </div>
            <div class="match-sets">
              ${match.sets.map((set, idx) => {
                if (set[0] === null && set[1] === null) return '';
                const p1WonSet = idx === 2 
                  ? (set[0] >= 10 && set[0] > set[1])
                  : (set[0] > set[1]);
                return `
                  <div class="set-score ${p1WonSet ? 'won' : ''}">
                    ç¬¬${idx + 1}ç›˜: ${set[0]} - ${set[1]}
                  </div>
                `;
              }).join('')}
            </div>
          </div>
        `;
      });

      container.innerHTML = html;
    }

    // æ¸²æŸ“é€‰æ‰‹åˆ—è¡¨
    function renderPlayers() {
      const container = document.getElementById('players-list');

      if (players.length === 0) {
        container.innerHTML = `
          <div class="empty-state" style="grid-column: 1/-1;">
            <span>ğŸ‘¥</span>
            <p>è¿˜æ²¡æœ‰é€‰æ‰‹</p>
          </div>
        `;
        return;
      }

      container.innerHTML = players.map(p => `
        <div class="player-card">
          <span>${p.name}</span>
          <button class="small danger" onclick="deletePlayer(${p.id})">åˆ é™¤</button>
        </div>
      `).join('');
    }

    // æ›´æ–°é€‰æ‰‹ä¸‹æ‹‰æ¡†
    function updatePlayerSelects() {
      const options = '<option value="">é€‰æ‹©é€‰æ‰‹</option>' + 
        players.map(p => `<option value="${p.id}">${p.name}</option>`).join('');
      
      document.getElementById('player1').innerHTML = options;
      document.getElementById('player2').innerHTML = options;
    }

    // æ·»åŠ é€‰æ‰‹
    async function addPlayer(name) {
      try {
        const { data, error } = await db
          .from('players')
          .insert([{ name }])
          .select()
          .single();

        if (error) throw error;
        
        players.push(data);
        renderAll();
      } catch (error) {
        alert('æ·»åŠ å¤±è´¥: ' + error.message);
      }
    }

    // åˆ é™¤é€‰æ‰‹
    async function deletePlayer(id) {
      if (!confirm('ç¡®å®šåˆ é™¤è¿™ä¸ªé€‰æ‰‹å—ï¼Ÿç›¸å…³æ¯”èµ›ä¹Ÿä¼šè¢«åˆ é™¤')) return;

      try {
        // å…ˆåˆ é™¤ç›¸å…³æ¯”èµ›
        await db
          .from('matches')
          .delete()
          .or(`player1_id.eq.${id},player2_id.eq.${id}`);

        // å†åˆ é™¤é€‰æ‰‹
        const { error } = await db
          .from('players')
          .delete()
          .eq('id', id);

        if (error) throw error;
        
        await loadData();
      } catch (error) {
        alert('åˆ é™¤å¤±è´¥: ' + error.message);
      }
    }

    // æ·»åŠ æ¯”èµ›
    async function addMatch(player1Id, player2Id, sets) {
      try {
        // æ£€æŸ¥æ˜¯å¦å·²ç»æ¯”è¿‡èµ›
        const existing = matches.find(m => 
          (m.player1_id === player1Id && m.player2_id === player2Id) ||
          (m.player1_id === player2Id && m.player2_id === player1Id)
        );

        if (existing) {
          alert('è¿™ä¸¤ä½é€‰æ‰‹å·²ç»æ¯”è¿‡èµ›äº†ï¼');
          return;
        }

        const { data, error } = await db
          .from('matches')
          .insert([{
            player1_id: player1Id,
            player2_id: player2Id,
            sets: sets
          }])
          .select()
          .single();

        if (error) throw error;
        
        matches.unshift(data);
        renderAll();
        alert('æ¯”èµ›ç»“æœå·²ä¿å­˜ï¼');
        
        // åˆ‡æ¢åˆ°æ’åé¡µ
        switchTab('rankings');
      } catch (error) {
        alert('ä¿å­˜å¤±è´¥: ' + error.message);
      }
    }

    // åˆ é™¤æ¯”èµ›
    async function deleteMatch(id) {
      if (!confirm('ç¡®å®šåˆ é™¤è¿™åœºæ¯”èµ›è®°å½•å—ï¼Ÿ')) return;

      try {
        const { error } = await db
          .from('matches')
          .delete()
          .eq('id', id);

        if (error) throw error;
        
        await loadData();
      } catch (error) {
        alert('åˆ é™¤å¤±è´¥: ' + error.message);
      }
    }

    // åˆ‡æ¢æ ‡ç­¾é¡µ
    function switchTab(tabId) {
      document.querySelectorAll('.tab').forEach(t => t.classList.remove('active'));
      document.querySelectorAll('.panel').forEach(p => p.classList.remove('active'));
      
      document.querySelector(`[data-tab="${tabId}"]`).classList.add('active');
      document.getElementById(tabId).classList.add('active');
    }

    // æ˜¾ç¤ºé”™è¯¯
    function showError(msg) {
      const container = document.getElementById('rankings-content');
      container.innerHTML = `<div class="error">${msg}</div>`;
    }

    // äº‹ä»¶ç›‘å¬
    function setupEventListeners() {
      // æ ‡ç­¾åˆ‡æ¢
      document.querySelectorAll('.tab').forEach(tab => {
        tab.addEventListener('click', () => switchTab(tab.dataset.tab));
      });

      // æ·»åŠ é€‰æ‰‹
      document.getElementById('player-form').addEventListener('submit', async (e) => {
        e.preventDefault();
        const input = document.getElementById('player-name');
        const name = input.value.trim();
        if (name) {
          await addPlayer(name);
          input.value = '';
        }
      });

      // æ·»åŠ æ¯”èµ›
      document.getElementById('match-form').addEventListener('submit', async (e) => {
        e.preventDefault();
        
        const player1Id = parseInt(document.getElementById('player1').value);
        const player2Id = parseInt(document.getElementById('player2').value);
        
        if (player1Id === player2Id) {
          alert('è¯·é€‰æ‹©ä¸åŒçš„é€‰æ‰‹ï¼');
          return;
        }

        const set1 = [
          parseInt(document.getElementById('set1-p1').value),
          parseInt(document.getElementById('set1-p2').value)
        ];
        const set2 = [
          parseInt(document.getElementById('set2-p1').value),
          parseInt(document.getElementById('set2-p2').value)
        ];
        const set3p1 = document.getElementById('set3-p1').value;
        const set3p2 = document.getElementById('set3-p2').value;
        const set3 = set3p1 !== '' && set3p2 !== '' 
          ? [parseInt(set3p1), parseInt(set3p2)]
          : [null, null];

        // éªŒè¯æ¯”åˆ†
        let p1Sets = 0, p2Sets = 0;
        if (set1[0] > set1[1]) p1Sets++; else p2Sets++;
        if (set2[0] > set2[1]) p1Sets++; else p2Sets++;

        if (p1Sets === 1 && p2Sets === 1) {
          // éœ€è¦ç¬¬ä¸‰ç›˜
          if (set3[0] === null || set3[1] === null) {
            alert('1:1 å¹³å±€éœ€è¦ç¬¬ä¸‰ç›˜æŠ¢åçš„æ¯”åˆ†ï¼');
            return;
          }
          if (set3[0] < 10 && set3[1] < 10) {
            alert('æŠ¢åæ¯”åˆ†è‡³å°‘æœ‰ä¸€æ–¹è¦è¾¾åˆ° 10 åˆ†ï¼');
            return;
          }
        } else if (set3[0] !== null) {
          alert('å·²ç» 2:0 å†³å‡ºèƒœè´Ÿï¼Œä¸éœ€è¦ç¬¬ä¸‰ç›˜ï¼');
          return;
        }

        await addMatch(player1Id, player2Id, [set1, set2, set3]);
        
        // æ¸…ç©ºè¡¨å•
        e.target.reset();
      });
    }

    // Load News/Scores from Supabase
    async function loadNews() {
      const container = document.getElementById('news-content');
      const updatedEl = document.getElementById('news-updated');
      
      try {
        const { data, error } = await db
          .from('score_snapshots')
          .select('content, fetched_at')
          .order('fetched_at', { ascending: false })
          .limit(1)
          .single();

        if (error) throw error;

        if (data) {
          // Render the markdown content
          container.innerHTML = `<div class="news-raw">${renderNewsContent(data.content)}</div>`;
          
          // Show last updated time
          const fetchedAt = new Date(data.fetched_at);
          updatedEl.textContent = `Updated: ${fetchedAt.toLocaleString()}`;
        } else {
          container.innerHTML = `
            <div class="news-empty">
              <span>ğŸ“°</span>
              <p>No scores available yet</p>
            </div>
          `;
        }
      } catch (error) {
        console.error('Failed to load news:', error);
        container.innerHTML = `
          <div class="news-empty">
            <span>âš ï¸</span>
            <p>Failed to load scores</p>
            <p style="font-size: 0.85rem; margin-top: 10px;">${error.message}</p>
          </div>
        `;
      }
    }

    // Simple markdown-like renderer for news content
    function renderNewsContent(content) {
      return content
        // Main headers (## Tournament Name)
        .replace(/^## (.+)$/gm, '<h3 class="news-tournament">$1</h3>')
        // Sub headers (### Match/Tie results)
        .replace(/^### (.+)$/gm, '<h4 class="news-tie">$1</h4>')
        // Bold text (**text**)
        .replace(/\*\*(.+?)\*\*/g, '<strong>$1</strong>')
        // Live matches (ğŸ”´ LIVE or In Progress)
        .replace(/ğŸ”´ LIVE/g, '<span class="live-badge">LIVE</span>')
        .replace(/In Progress ğŸ”´/g, '<span class="live-badge">LIVE</span>')
        // Completed matches (âœ“)
        .replace(/âœ“/g, '<span style="color: var(--accent);">âœ“</span>')
        // List items (- Player vs Player)
        .replace(/^- (.+)$/gm, '<div class="news-match">$1</div>')
        // Line breaks
        .replace(/\n\n/g, '<br>')
        .replace(/\n/g, '');
    }

    // å¯åŠ¨
    init();
    
    // Also load news after init
    setTimeout(() => {
      if (db) loadNews();
    }, 500);
  </script>
</body>
</html>

